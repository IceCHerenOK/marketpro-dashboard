import express from 'express';
import cors from 'cors';
import helmet from 'helmet';
import compression from 'compression';
import path from 'path';
import dotenv from 'dotenv';

// Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ Ñ€Ğ¾ÑƒÑ‚ĞµÑ€Ğ¾Ğ²
import authRoutes from './routes/auth';
import marketplaceRoutes from './routes/marketplaces';
import ordersRoutes from './routes/orders';
import productsRoutes from './routes/products';
import analyticsRoutes from './routes/analytics';
import financeRoutes from './routes/finance';
import advertisingRoutes from './routes/advertising';
import settingsRoutes from './routes/settings';

// Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ middleware
import errorHandler from './middleware/errorHandler';
import requestLogger from './middleware/logger';

// Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
import initDatabase from './database/init';

dotenv.config()

const app = express()
const PORT = process.env.PORT || 3001

// Middleware
app.use(helmet())
app.use(compression())
app.use(cors({
  origin: process.env.NODE_ENV === 'development' 
    ? 'http://localhost:5173' 
    : false,
  credentials: true
}))
app.use(express.json({ limit: '10mb' }))
app.use(express.urlencoded({ extended: true, limit: '10mb' }))
app.use(requestLogger)

// Ğ¡Ñ‚Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹
if (process.env.NODE_ENV !== 'development') {
  app.use(express.static(path.join(__dirname, '../frontend')))
}

// API Ñ€Ğ¾ÑƒÑ‚Ñ‹
// ĞšĞ¾Ñ€Ğ½ĞµĞ²Ğ¾Ğ¹ API ÑĞ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚
app.get('/api', (req, res) => {
  res.json({
    message: 'Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² API Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¼Ğ°Ñ€ĞºĞµÑ‚Ğ¿Ğ»ĞµĞ¹ÑĞ°Ğ¼Ğ¸',
    version: '1.0.0',
    endpoints: [
      '/api/auth - ĞÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼Ğ¸',
      '/api/marketplaces - Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¼Ğ°Ñ€ĞºĞµÑ‚Ğ¿Ğ»ĞµĞ¹ÑĞ°Ğ¼Ğ¸',
      '/api/orders - Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ°ĞºĞ°Ğ·Ğ°Ğ¼Ğ¸',
      '/api/products - Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼Ğ¸',
      '/api/analytics - ĞĞ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ° Ğ¸ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°',
      '/api/finance - Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğµ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸',
      '/api/advertising - Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ€ĞµĞºĞ»Ğ°Ğ¼Ğ¾Ğ¹'
    ]
  })
})

app.use('/api/auth', authRoutes)
app.use('/api/marketplaces', marketplaceRoutes)
app.use('/api/orders', ordersRoutes)
app.use('/api/products', productsRoutes)
app.use('/api/analytics', analyticsRoutes)
app.use('/api/finance', financeRoutes)
app.use('/api/advertising', advertisingRoutes)
app.use('/api/settings', settingsRoutes)

// ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° SPA Ñ€Ğ¾ÑƒÑ‚Ğ¸Ğ½Ğ³Ğ°
if (process.env.NODE_ENV !== 'development') {
  app.get('*', (_req: any, res: any) => {
    res.sendFile(path.join(__dirname, '../frontend/index.html'))
  })
}

// ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
app.use(errorHandler)

// Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞº ÑĞµÑ€Ğ²ĞµÑ€Ğ°
async function startServer() {
  try {
    console.log('ğŸ”„ Ğ—Ğ°Ğ¿ÑƒÑĞº ÑĞµÑ€Ğ²ĞµÑ€Ğ°...')
    console.log('ğŸ“ Ğ Ğ°Ğ±Ğ¾Ñ‡Ğ°Ñ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ:', process.cwd())
    console.log('ğŸŒ NODE_ENV:', process.env.NODE_ENV)
    console.log('ğŸ”Œ PORT:', PORT)
    
    console.log('ğŸ”„ Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…...')
    await initDatabase()
    console.log('âœ… Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ°')
    
    app.listen(PORT, () => {
      console.log(`ğŸš€ Ğ¡ĞµÑ€Ğ²ĞµÑ€ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½ Ğ½Ğ° Ğ¿Ğ¾Ñ€Ñ‚Ñƒ ${PORT}`)
      console.log(`ğŸ“Š ĞŸĞ°Ğ½ĞµĞ»ÑŒ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¼Ğ°Ñ€ĞºĞµÑ‚Ğ¿Ğ»ĞµĞ¹ÑĞ°Ğ¼Ğ¸ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ° Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ`)
      console.log(`ğŸŒ Backend API: http://localhost:${PORT}/api`)
    })
  } catch (error) {
    console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğ°:', error)
    console.error('ğŸ“‹ Stack trace:', (error as Error).stack)
    process.exit(1)
  }
}

console.log('ğŸ¯ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¼Ğ¾Ğ´ÑƒĞ»ĞµĞ¹ ÑĞµÑ€Ğ²ĞµÑ€Ğ°...')
console.log('ğŸ“¦ Express Ğ²ĞµÑ€ÑĞ¸Ñ:', require('express/package.json').version)
console.log('ğŸ”§ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° middleware...')

startServer()